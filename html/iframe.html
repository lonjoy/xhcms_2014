<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>全局配置_head_left</title>
	<link rel="stylesheet" href="../css/jqueryui/jquery-ui.css">
	<link rel="stylesheet" href="../css/form.css">
	<script src="../js/jquery.min.js"></script>
	<script src="../js/require.js"></script>
	<script src="../js/require-config.js"></script>
</head>
<body>
	<div class="head">
		<div class="head_top">
			<span class="headIcon skin_peeler">换肤</span>
			<span id="now-time"></span>
			<div class="head_login">
				<i class="headIcon sizeOn head_exit">&nbsp;</i>
				<i class="headIcon sizeOn head_settings">&nbsp;</i>
				<i class="headIcon sizeOn head_receiving">&nbsp;<font>1</font></i>
				<span class="login_name">秋瑟</span>		
			</div>
		</div>
		<div class="head_nav">
			<div class="head_select">
				<select name="sel" id="site-select">
					<option value="1" selected="selected">云悦知主站</option>
					<option value="2">云悦知测试站</option>
				</select>
			</div>
			<div class="nav">
				
			</div>
		</div>
	</div>
	<div class="mainBox">
		<div class="mainHead">	
		</div>
		<div class="mainBody clearfix" >
			<dl class="tree-nav" id="tree-nav">

			</dl>
			<div class="tree-module" id="tree-module">
				<ul class="ztree" id="ztree-inner"></ul>
			</div>
			<div class="tree-target" id="tree-target">
				<iframe name="targetFrame" id="targetFrame" src="http://172.18.11.69" frameborder="0" style="width:100%;min-height:600px;"></iframe>
			</div>
		</div>
	</div>


<script type="template/html" id="md-nav">
	<ul>
		{{#each content}}
		<li><a class="out {{#if childMenus.length}}with-nav{{/if}}" href="{{url}}" target="targetFrame" data-id="{{id}}" id="top-nav-{{id}}">{{name}}</a>
			{{#if childMenus.length}}
			<div class="Tmenu">
				{{#each childMenus}}
				<a href="{{url}}" target="targetFrame" id="top-nav-{{id}}" data-id="{{id}}" class="{{#if childMenus.length}}with-nav{{/if}}">{{name}}</a>
				{{/each}}
			</div>
			{{/if}}
		</li>
		{{/each}}
	</ul>
</script>

<script type="template/html" id="md-nav-sub">
	{{#each childMenus}}
		<dt class="{{#if childMenus.length}}no-link{{else}}link{{/if}}"><a href="{{url}}" class="{{type}}" target="targetFrame" id="tree-nav-{{id}}" data-id="{{id}}">{{name}}</a></dt>
		<dd>
			{{#each childMenus}}
			<a href="{{url}}" class="{{type}}" target="targetFrame" id="tree-nav-{{id}}" data-id="{{id}}">{{name}}</a>
			{{/each}}
		</dd>
	{{/each}}
</script>

<script type="template/html" id="md-main-head">
	{{#each this}}
		<a href="{{url}}" class="{{#if childMenus.length}}with-nav{{/if}}" data-id="{{id}}" target="targetFrame">{{name}}</a> &gt; 
	{{/each}}
</script>

	
<script>
	//异步加载导航和菜单
	require(["template"],function(){

		var nav = Handlebars.compile( $("#md-nav").html() );
		var sub = Handlebars.compile( $("#md-nav-sub").html() );
		var crumb = Handlebars.compile( $("#md-main-head").html() );

		var tree = $("#tree-nav"), treeHolder = $("#tree-module"), rightTarget = $("#tree-target");

		$.ajax({
			url : "json/menu.json",
			dataType : "json",
			success: function(n){
				$(".nav").html( nav(n) );

				var m = {};

				//将结果数据通过id作为key标识成map。
				var toMap = function(n){
					for (var i = 0; i < n.length; i++) {
						m[ n[i].id ] = n[i];
						toMap( n[i].childMenus );
					};
				}
				toMap(n.content); 

				//根据id获取当前节点的导航回溯。
				var toChain = function(id){	
					var chain = [], cid = id, temp;
					while( temp = m[cid] ){
						chain.splice(0,0,temp);
						cid = temp.parentId;
					}
					return chain;
				}

				//顶部和面包屑事件触发
				$(".nav, .mainHead").on('click','a',function(){
					var _this = $(this), id = _this.attr('data-id');
					if( _this.hasClass("with-nav") ){
						tree.html( sub(m[ id ]) );

						tree.animate({
							width: "8%",
							opacity: 1
						},'fast');
						rightTarget.animate({
							width: "42%"
						},'fast');
					}else{
						tree.html("");
						
						tree.animate({
							width: "0%",
							opacity: 0
						},'fast');
						rightTarget.animate({
							width: "50%"
						},'fast');

					}
					$(".mainHead").html( crumb( toChain( $(this).attr("data-id") ) ) );
				});  

				//左侧导航触发
				$("#tree-nav").on('click','a',function(){
					$(".mainHead").html( crumb( toChain( $(this).attr("data-id") ) ) );
				});

				
				require(["module/queryparam"],function(queryparam){
					var id = queryparam("id") || 1;
					$("#top-nav-"+id).trigger("click");
				});

			}
		});




	});	
</script>


<script src="../js/main.js"></script>
</body>
</html>