<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>炫知新闻加工后台</title>
	<link rel="stylesheet" href="../css/jqueryui/jquery-ui.css">
	<link rel="stylesheet" href="../css/form.css">
	<script src="../js/jquery.min.js"></script>
	<script src="../js/require.js"></script>
	<script src="../js/require-config.js"></script>
</head>
<body>
	<div class="head">
		<div class="head_top">
			<span class="headIcon skin_peeler">换肤</span>
			<span id="now-time"></span>
			<div class="head_login">
				<a class="headIcon sizeOn head_exit" href="../../xhadmin/logout.do?returnUrl=index.do" onclick="return confirm('您确定退出吗？')">&nbsp;</a>
				<a class="headIcon sizeOn head_settings" href="../../xhadmin/personal/v_profile.do" target="targetFrame">&nbsp;</a>
				<a class="headIcon sizeOn head_receiving" href="../../xhadmin/message/v_list.do" target="targetFrame">&nbsp;<i id="count-receiving">?</i></a>
				<span class="login_name">[未知用户]</span>		
			</div>
			<span class="t-handle">-</span>
		</div>
		<div class="head_nav">
			<div class="head_select">
				<select name="sel" id="site-select">
					<option value="1" selected="selected">云悦知主站</option>
					<option value="2">云悦知测试站</option>
					<option value="3">发稿平台</option>
				</select>
			</div>
			<div class="nav">
				
			</div>
		</div>
	</div>
	<div class="mainBox">
		<div class="mainHead">	
		</div>
		<div class="mainBody clearfix" >
			<dl class="tree-nav" id="tree-nav">

			</dl>
			<div class="tree-module" id="tree-module">
				<ul class="ztree" id="ztree-inner"></ul>
			</div>
			<div class="tree-target" id="tree-target">
				<iframe name="targetFrame" id="targetFrame" src="../../xhadmin/main.do" frameborder="0" style="width:100%;min-height:700px;"></iframe>
			</div>
		</div>
	</div>


<script type="template/html" id="md-nav">
	<ul>
		{{#each content}}
		<li><a class="out {{type}}" href="{{#if url}}../../xhadmin{{url}}{{else}}about:blank{{/if}}" target="targetFrame" data-id="{{id}}" id="top-nav-{{id}}">{{name}}</a>
			{{#if childMenus.length}}
			<div class="Tmenu">
				{{#each childMenus}}
				<a href="{{#if url}}../../xhadmin{{url}}{{else}}about:blank{{/if}}" target="targetFrame" id="top-nav-{{id}}" data-id="{{id}}" class="{{#if childMenus.length}}with-nav{{/if}}">{{name}}</a>
				{{/each}}
			</div>
			{{/if}}
		</li>
		{{/each}}
	</ul>
</script>

<script type="template/html" id="md-nav-sub">
	{{#each childMenus}}
		<dt class="{{type}} {{#if childMenus.length}}with-sub{{else}}without-sub{{/if}} dt-open"><a href="{{#if url}}../../xhadmin{{url}}{{else}}about:blank{{/if}}" class="{{type}}" target="targetFrame" id="tree-nav-{{id}}" data-id="{{id}}">{{name}}</a></dt>
		<dd style="display:block;" href="{{#if url}}../../xhadmin{{url}}{{/if}}">
			{{#each childMenus}}
			<a href="{{#if url}}../../xhadmin{{url}}{{else}}about:blank{{/if}}" class="{{type}}" target="targetFrame" id="tree-nav-{{id}}" data-id="{{id}}">{{name}}</a>
			{{/each}}
		</dd>
	{{/each}}
</script>

<script type="template/html" id="md-main-head">
	{{#each this}}
		<a href="{{#if url}}../../xhadmin{{url}}{{else}}about:blank{{/if}}" class="{{#if childMenus.length}}with-nav{{/if}} {{type}}" data-id="{{id}}" target="targetFrame">{{name}}</a> &gt; 
	{{/each}}
</script>

	
<script>
	
	window.baseUrl = $("<a href='../'></a>")[0].href;

	$("#site-select").on('change',function(){
		if( this.value == 3 ){
			window.open("../../xhcms0.2/main.html");
		}
	});


	$("#targetFrame").on("load",function(){	//frame加载完成，添加frame.css样式表
		var doc = $(this).contents()[0];
		var t = $('<link rel="stylesheet" href="'+baseUrl+'css/frame.css" />')[0];
		doc.body.appendChild( t );
	});

	$.ajax({		//获取登录用户信息
		url: "../../xhadmin/basic/getCurrentUser.do",
		type:"post",
		dataType:"json",
		success: function(data){
			if(data.success){
				$(".login_name").html(data.content.username);
			}
		}
	});

	require(["requestAFrame"],function(r){
		r.addTimeout("count-receiving",(function(){
			var fn = function(){
				$.ajax({
					url: "../../xhadmin/message/v_countUnreadMsg.do",
					type:"post",
					dataType:"json",
					success: function(data){
						if(data.result){
							 $("#count-receiving").html(data.count).css({
							 	visibility: (data.count > 0 ? "visible" : "hidden")
							 });

						}else{
							alert("请先登录");
						}
					}
				});
			};
			fn();
			return fn;		
		})(),1000*30);
	});

	//异步加载导航和菜单
	require(["template"],function(){

		var nav = Handlebars.compile( $("#md-nav").html() );
		var sub = Handlebars.compile( $("#md-nav-sub").html() );
		var crumb = Handlebars.compile( $("#md-main-head").html() );

		var tree = $("#tree-nav"), treeHolder = $("#tree-module"), rightTarget = $("#tree-target");

		$.ajax({
			url : "../../xhadmin/basic/getMenu.do",
			dataType : "json",
			success: function(n){
				$(".nav").html( nav(n) );

				var m = {};

				//将结果数据通过id作为key标识成map。
				var toMap = function(n){
					for (var i = 0; i < n.length; i++) {
						m[ n[i].id ] = n[i];
						toMap( n[i].childMenus );
					};
				}
				toMap(n.content); 

				//根据id获取当前节点的导航回溯。
				var toChain = function(id){	
					var chain = [], cid = id, temp;
					while( temp = m[cid] ){
						chain.splice(0,0,temp);
						cid = temp.parentId;
					}
					return chain;
				}

				//顶部和面包屑事件触发
				$(".nav, .mainHead, .head_login").on('click','a',function(){
					var _this = $(this), id = _this.attr('data-id');

					if( _this.hasClass("super-nav") || _this.hasClass("tree-link") || _this.next().hasClass("tree-link") ){	// 有子节点的一级导航不要点击事件
						return false;
					}

					if( _this.hasClass("with-nav") ){
						
						tree.html( sub(m[ id ]) );

						tree.animate({
							width: "8%",
							opacity: 1
						},'fast');
						rightTarget.animate({
							width: "42%"
						},'fast',function(){
							var tarLink = tree.find('a.link').first().addClass('selected').one('click',function(e){e.stopPropagation();});
							tarLink[0].click();
						});
					}else{
						tree.html("");
						
						tree.animate({
							width: "0%",
							opacity: 0
						},'fast');
						rightTarget.animate({
							width: "50%"
						},'fast');

					}
					$(".mainHead").html( crumb( toChain( $(this).attr("data-id") ) ) );
				});  

				//左侧导航触发
				$("#tree-nav").on('click','a',function(){
					$(".mainHead").html( crumb( toChain( $(this).attr("data-id") ) ) );
				});

				
				require(["module/queryparam"],function(queryparam){
					var id = queryparam("id") || 1;
					var t = $("#top-nav-"+id)[0];
					t ? t.click() : alert("wrong id:"+id);
				});

			}
		});




	});	
</script>


<script src="../js/main.js"></script>
</body>
</html>